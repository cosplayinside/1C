//////////////////////////////////////////
//       CIS 09_12_2021 10_03          //
////////////////////////////////////////

ВЫБРАТЬ РАЗРЕШЕННЫЕ
	Резолюции.АвторРезолюции КАК АвторРезолюции,
	Резолюции.ДатаРезолюции КАК ДатаРезолюции,
	ВЫРАЗИТЬ(Резолюции.ТекстРезолюции КАК СТРОКА(200)) КАК Резолюция,
	Резолюции.Документ КАК Ссылка
ПОМЕСТИТЬ ПоследняяРезолюция
ИЗ
	Справочник.Резолюции КАК Резолюции
		ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
			МАКСИМУМ(ВнутреннийДокументРезолюции.ДатаРезолюции) КАК ДатаРезолюции,
			ВнутреннийДокументРезолюции.Документ КАК Ссылка
		ИЗ
			Справочник.Резолюции КАК ВнутреннийДокументРезолюции
		ГДЕ
			НЕ ВнутреннийДокументРезолюции.ПометкаУдаления
		
		СГРУППИРОВАТЬ ПО
			ВнутреннийДокументРезолюции.Документ) КАК МаксРезолюции
		ПО (Резолюции.ДатаРезолюции = МаксРезолюции.ДатаРезолюции)
			И (МаксРезолюции.Ссылка = Резолюции.Документ)
ГДЕ
	НЕ Резолюции.ПометкаУдаления
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ РАЗРЕШЕННЫЕ
	ВнутреннийДокумент.РегистрационныйНомер КАК РегистрационныйНомер,
	ВнутреннийДокумент.ДатаРегистрации КАК ДатаРегистрации,
	ВнутреннийДокумент.ВидДокумента КАК ВидДокумента,
	ВнутреннийДокумент.Ссылка КАК Ссылка,
	ВнутреннийДокумент.Ссылка КАК ВнутреннийДокумент,
	ВнутреннийДокумент.Подготовил КАК Подготовил,
	ВнутреннийДокумент.Утвердил КАК Утвердил,
	ВнутреннийДокумент.Дело КАК Дело,
	ВнутреннийДокумент.СрокИсполнения КАК ПлановыйСрокИсполнения,
	ВнутреннийДокумент.Зарегистрировал КАК Зарегистрировал,
	ВнутреннийДокумент.Папка КАК Папка,
	ВнутреннийДокумент.Организация КАК Организация,
	ВнутреннийДокумент.Ответственный КАК Ответственный,
	ПоследняяРезолюция.АвторРезолюции КАК АвторРезолюции,
	ПоследняяРезолюция.ДатаРезолюции КАК ДатаРезолюции,
	ПоследняяРезолюция.Резолюция КАК Резолюция,
	ВнутреннийДокумент.Проект КАК Проект,
	ВнутреннийДокумент.Валюта КАК Валюта,
	ВнутреннийДокумент.Сумма КАК Сумма,
	СостоянияДокументов.Период КАК ФактическийСрокИсполнения,
	ВЫБОР
		КОГДА СостоянияДокументов.Период ЕСТЬ NULL
			ТОГДА ЛОЖЬ
		ИНАЧЕ ИСТИНА
	КОНЕЦ КАК Исполнен,
	ОбщиеРеквизитыДокументов.ПредставлениеСостояния КАК ПредставлениеСостояния,
	ВЫРАЗИТЬ(ЕСТЬNULL(Визы.Комментарий, "") КАК СТРОКА(200)) КАК КомментарийОтПилипенко
ПОМЕСТИТЬ ВТ_Результат
ИЗ
	Справочник.ВнутренниеДокументы КАК ВнутреннийДокумент
		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
			ТекущиеСостоянияДокументов.Состояние КАК Состояние,
			ТекущиеСостоянияДокументов.Документ КАК Документ,
			ТекущиеСостоянияДокументов.ДатаУстановки КАК Период
		ИЗ
			РегистрСведений.ТекущиеСостоянияДокументов КАК ТекущиеСостоянияДокументов) КАК СостоянияДокументов
		ПО (СостоянияДокументов.Документ = ВнутреннийДокумент.Ссылка)
			И (СостоянияДокументов.Состояние = ЗНАЧЕНИЕ(Перечисление.СостоянияДокументов.Исполнен))
		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОбщиеРеквизитыДокументов КАК ОбщиеРеквизитыДокументов
		ПО (ОбщиеРеквизитыДокументов.Документ = ВнутреннийДокумент.Ссылка)
		ЛЕВОЕ СОЕДИНЕНИЕ ПоследняяРезолюция КАК ПоследняяРезолюция
		ПО (ВнутреннийДокумент.Ссылка = ПоследняяРезолюция.Ссылка)
		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
			ВизыСогласования.Комментарий КАК Комментарий,
			ВизыСогласования.Документ.Ссылка КАК ДокументСсылка
		ИЗ
			Справочник.ВизыСогласования КАК ВизыСогласования
		ГДЕ
			ВизыСогласования.ПомещенаВИсторию = ЛОЖЬ
			И ВизыСогласования.Удалена = ЛОЖЬ
			И ВизыСогласования.ПометкаУдаления = ЛОЖЬ
			И ВизыСогласования.Исполнитель.Наименование ПОДОБНО "Пилипенко Павел Игоревич%") КАК Визы
		ПО (ВнутреннийДокумент.Ссылка = Визы.ДокументСсылка)
{ГДЕ
	(ИСТИНА В
				(ВЫБРАТЬ ПЕРВЫЕ 1
					ИСТИНА
				ИЗ
					РегистрСведений.КатегорииОбъектов КАК КатегорииОбъектов
				ГДЕ
					КатегорииОбъектов.ОбъектДанных = ВнутреннийДокумент.Ссылка
					И КатегорииОбъектов.КатегорияДанных В (&СписокКатегорий))
			ИЛИ ЛОЖЬ В
				(ВЫБРАТЬ
					Константы.ИспользоватьКатегорииДанных
				ИЗ
					Константы КАК Константы)) КАК Поле2,
	(ВнутреннийДокумент.ПометкаУдаления = ЛОЖЬ
			ИЛИ &ПоказыватьПомеченныеНаУдаление = ИСТИНА) КАК Поле4,
	(&Состояние В
			(ВЫБРАТЬ
				РегистрСведений.ТекущиеСостоянияДокументов.Состояние
			ИЗ
				РегистрСведений.ТекущиеСостоянияДокументов
			ГДЕ
				РегистрСведений.ТекущиеСостоянияДокументов.Документ = ВнутреннийДокумент.Ссылка)) КАК Поле6,
	(ВЫБОР
			КОГДА ВнутреннийДокумент.РегистрационныйНомер <> ""
				ТОГДА ВнутреннийДокумент.ДатаРегистрации
			ИНАЧЕ ВнутреннийДокумент.ДатаСоздания
		КОНЕЦ МЕЖДУ &ДатаНачала И &ДатаОкончания) КАК Поле8,
	(ВнутреннийДокумент.РегистрационныйНомер = ""
				И &ПоказыватьДокументы = ЗНАЧЕНИЕ(Перечисление.ПоказыватьДокументы.НеЗарегистрированные)
			ИЛИ ВнутреннийДокумент.РегистрационныйНомер <> ""
				И &ПоказыватьДокументы = ЗНАЧЕНИЕ(Перечисление.ПоказыватьДокументы.Зарегистрированные)
			ИЛИ &ПоказыватьДокументы = ЗНАЧЕНИЕ(Перечисление.ПоказыватьДокументы.Все)) КАК Поле10,
	(ВЫБОР
			КОГДА &ДокументыСИстекающимСрокомДействия
				ТОГДА ВнутреннийДокумент.ДатаОкончанияДействия <> ДАТАВРЕМЯ(1, 1, 1)
						И НЕ ВнутреннийДокумент.НеДействует
						И (ВнутреннийДокумент.Ответственный = &ТекущийПользователь
							ИЛИ ВнутреннийДокумент.Ответственный = ЗНАЧЕНИЕ(Справочник.Пользователи.ПустаяСсылка)
								И ВнутреннийДокумент.Подготовил = &ТекущийПользователь)
						И ВнутреннийДокумент.ДатаОкончанияДействия >= &ТекущаяДата
						И ВнутреннийДокумент.ДатаОкончанияДействия <= КОНЕЦПЕРИОДА(ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, 2), ДЕНЬ)
			ИНАЧЕ ИСТИНА
		КОНЕЦ) КАК Поле12,
	(ВЫБОР
			КОГДА &ДокументыСИстекшимСрокомДействия
				ТОГДА ВнутреннийДокумент.ДатаОкончанияДействия <> ДАТАВРЕМЯ(1, 1, 1)
						И НЕ ВнутреннийДокумент.НеДействует
						И (ВнутреннийДокумент.Ответственный = &ТекущийПользователь
							ИЛИ ВнутреннийДокумент.Ответственный = ЗНАЧЕНИЕ(Справочник.Пользователи.ПустаяСсылка)
								И ВнутреннийДокумент.Подготовил = &ТекущийПользователь)
						И ВнутреннийДокумент.ДатаОкончанияДействия < &ТекущаяДата
						И ВнутреннийДокумент.ПорядокПродления = ЗНАЧЕНИЕ(Перечисление.ПорядокПродления.ДопускаетПродление)
			ИНАЧЕ ИСТИНА
		КОНЕЦ) КАК Поле14,
	(ВЫБОР
			КОГДА &ДокументыСИстекающимСрокомИсполнения
				ТОГДА ВнутреннийДокумент.СрокИсполнения <> ДАТАВРЕМЯ(1, 1, 1)
						И НЕ ВнутреннийДокумент.НеДействует
						И (ВнутреннийДокумент.Ответственный = &ТекущийПользователь
							ИЛИ ВнутреннийДокумент.Ответственный = ЗНАЧЕНИЕ(Справочник.Пользователи.ПустаяСсылка)
								И ВнутреннийДокумент.Подготовил = &ТекущийПользователь)
						И СостоянияДокументов.Состояние ЕСТЬ NULL
						И ВнутреннийДокумент.СрокИсполнения >= &ТекущаяДата
						И ВнутреннийДокумент.СрокИсполнения <= КОНЕЦПЕРИОДА(ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, 2), ДЕНЬ)
			ИНАЧЕ ИСТИНА
		КОНЕЦ) КАК Поле16,
	(ВЫБОР
			КОГДА &ДокументыПросроченные
				ТОГДА ВнутреннийДокумент.СрокИсполнения <> ДАТАВРЕМЯ(1, 1, 1)
						И НЕ ВнутреннийДокумент.НеДействует
						И (ВнутреннийДокумент.Ответственный = &ТекущийПользователь
							ИЛИ ВнутреннийДокумент.Ответственный = ЗНАЧЕНИЕ(Справочник.Пользователи.ПустаяСсылка)
								И ВнутреннийДокумент.Подготовил = &ТекущийПользователь)
						И СостоянияДокументов.Состояние ЕСТЬ NULL
						И ВнутреннийДокумент.СрокИсполнения < &ТекущаяДата
			ИНАЧЕ ИСТИНА
		КОНЕЦ) КАК Поле18}
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ВТ_Результат.РегистрационныйНомер КАК РегистрационныйНомер,
	ВТ_Результат.ДатаРегистрации КАК ДатаРегистрации,
	ВТ_Результат.ВидДокумента КАК ВидДокумента,
	ВТ_Результат.Ссылка КАК Ссылка,
	ВТ_Результат.ВнутреннийДокумент КАК ВнутреннийДокумент,
	ВТ_Результат.Подготовил КАК Подготовил,
	ВТ_Результат.Утвердил КАК Утвердил,
	ВТ_Результат.Дело КАК Дело,
	ВТ_Результат.ПлановыйСрокИсполнения КАК ПлановыйСрокИсполнения,
	ВТ_Результат.Зарегистрировал КАК Зарегистрировал,
	ВТ_Результат.Папка КАК Папка,
	ВТ_Результат.Организация КАК Организация,
	ВТ_Результат.Ответственный КАК Ответственный,
	ВТ_Результат.АвторРезолюции КАК АвторРезолюции,
	ВТ_Результат.ДатаРезолюции КАК ДатаРезолюции,
	ВТ_Результат.Резолюция КАК Резолюция,
	ВТ_Результат.Проект КАК Проект,
	ВТ_Результат.Валюта КАК Валюта,
	ВТ_Результат.Сумма КАК Сумма,
	ВТ_Результат.ФактическийСрокИсполнения КАК ФактическийСрокИсполнения,
	ВТ_Результат.Исполнен КАК Исполнен,
	ВТ_Результат.ПредставлениеСостояния КАК ПредставлениеСостояния,
	ВТ_Результат.КомментарийОтПилипенко КАК КомментарийОтПилипенко
ИЗ
	ВТ_Результат КАК ВТ_Результат

СГРУППИРОВАТЬ ПО
	ВТ_Результат.РегистрационныйНомер,
	ВТ_Результат.ДатаРегистрации,
	ВТ_Результат.ВидДокумента,
	ВТ_Результат.Ссылка,
	ВТ_Результат.ВнутреннийДокумент,
	ВТ_Результат.Подготовил,
	ВТ_Результат.Утвердил,
	ВТ_Результат.Дело,
	ВТ_Результат.ПлановыйСрокИсполнения,
	ВТ_Результат.Зарегистрировал,
	ВТ_Результат.Папка,
	ВТ_Результат.Организация,
	ВТ_Результат.Ответственный,
	ВТ_Результат.АвторРезолюции,
	ВТ_Результат.ДатаРезолюции,
	ВТ_Результат.Резолюция,
	ВТ_Результат.Проект,
	ВТ_Результат.Валюта,
	ВТ_Результат.Сумма,
	ВТ_Результат.ФактическийСрокИсполнения,
	ВТ_Результат.Исполнен,
	ВТ_Результат.ПредставлениеСостояния,
	ВТ_Результат.КомментарийОтПилипенко
